---
import data from 'public/games.json'
import { TOC, BackToTop } from 'astro-pure/components/pages'
import { Icon } from 'astro-pure/user'
import BaseLayout from '@/layouts/BaseLayout.astro'
import GameStats from '@/components/games/GameStats.astro'
import config from '@/site-config'

// ç±»å‹å®šä¹‰
interface GameItem {
  name: string
  rating?: string
  play_date?: string
  description?: string
  image?: string
  link?: string
  achievements?: string
}

// è·å–æ‰€æœ‰åˆ†ç±»çš„æ•°æ®
const playing = data.playing as GameItem[]
const played = data.played as GameItem[]

// åŠ¨æ€ç”Ÿæˆ headingsï¼ŒåªåŒ…å«æœ‰å†…å®¹çš„åˆ†ç±»
const headings = [
  ...(playing.length > 0 ? [{ depth: 2, slug: 'playing', text: 'æ­£åœ¨æ¸¸ç©' }] : []),
  ...(played.length > 0 ? [{ depth: 2, slug: 'played', text: 'å·²ç»ç©è¿‡' }] : [])
]
---

<BaseLayout
  meta={{ title: 'æ¸¸æˆ', description: config.description }}
  wide={true}
>
  <div class='grid grid-cols-1 lg:grid-cols-[240px_1fr] gap-10'>
    {/* Sidebar */}
    <aside class='lg:block'>
      <div class='sticky top-24 space-y-8'>
        <TOC headings={headings} />
        <GameStats {playing} {played} />
      </div>
    </aside>

    {/* Mobile sidebar */}
    <aside
      class='lg:hidden fixed top-20 start-4 z-40 w-48 bg-muted border rounded-xl px-4 py-3 overflow-y-auto'
      style='max-height: calc(100vh - 7rem); display: none;'
      id='sidebar-mobile'
    >
      <TOC headings={headings} />
      <GameStats {playing} {played} />
    </aside>
    <div
      id='sidebar-shade'
      class='fixed top-0 start-0 w-full h-full lg:hidden'
      style='display:none;background-color:#00000091;z-index:31'
    >
    </div>

    {/* Main Content */}
    <div class='min-w-0'>
      <div id='content-header' class='animate mb-8'>
        <h1 class='text-3xl font-bold sm:text-4xl'>æ¸¸æˆ</h1>
        <p class='mt-2 text-muted-foreground'>
          ç¬¬ä¹è‰ºæœ¯ Â· é€ƒé¿ç°å®çš„æœ€å¥½æ–¹å¼ï¼ˆå¹¶ä¸ï¼‰
          <span class='ml-2 text-sm'>ğŸ†å…¨æ”¶é›† ğŸ…å…¨æˆå°±</span>
        </p>
      </div>

      <article id='content'>
        {/* æ­£åœ¨æ¸¸ç© */}
        {playing.length > 0 && (
          <>
            <h2 id='playing' class='text-2xl font-semibold mb-6'>æ­£åœ¨æ¸¸ç©</h2>
            <div class='grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4 mb-12'>
              {
                playing.map((game, index) => (
                  <div class='group overflow-hidden rounded-xl border bg-card shadow-sm transition-all hover:shadow-md'>
                    <a href={game.link} target='_blank' rel='noopener noreferrer' class='block overflow-hidden' style='aspect-ratio: 460 / 215;'>
                      <img
                        src={game.image}
                        alt={game.name}
                        class='h-full w-full object-cover transition-transform duration-300 group-hover:scale-105'
                        loading={index < 4 ? 'eager' : 'lazy'}
                        fetchpriority={index < 2 ? 'high' : 'auto'}
                      />
                    </a>
                    <div class='p-3'>
                      <h3 class='text-lg font-bold leading-tight'>
                        {game.name}
                        {game.achievements && <span class='ml-1'>{game.achievements}</span>}
                      </h3>
                      <div class='mt-2 flex items-center justify-between'>
                        <span class='text-xs text-muted-foreground'>{game.play_date || 'æœªè®°å½•'}</span>
                        <span class='text-xs'>{game.rating}</span>
                      </div>
                      <p class='mt-3 text-sm text-muted-foreground'>{game.description}</p>
                    </div>
                  </div>
                ))
              }
            </div>
          </>
        )}

        {/* å·²ç»ç©è¿‡ */}
        {played.length > 0 && (
          <>
            <h2 id='played' class='text-2xl font-semibold mb-6'>å·²ç»ç©è¿‡</h2>
            <div class='grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4'>
              {
                played.map((game, index) => (
                  <div class='group overflow-hidden rounded-xl border bg-card shadow-sm transition-all hover:shadow-md'>
                    <a href={game.link} target='_blank' rel='noopener noreferrer' class='block overflow-hidden' style='aspect-ratio: 460 / 215;'>
                      <img
                        src={game.image}
                        alt={game.name}
                        class='h-full w-full object-cover transition-transform duration-300 group-hover:scale-105'
                        loading={index < 8 ? 'eager' : 'lazy'}
                        fetchpriority={index < 4 ? 'high' : 'auto'}
                      />
                    </a>
                    <div class='p-3'>
                      <h3 class='text-lg font-bold leading-tight'>
                        {game.name}
                        {game.achievements && <span class='ml-1'>{game.achievements}</span>}
                      </h3>
                      <div class='mt-2 flex items-center justify-between'>
                        <span class='text-xs text-muted-foreground'>{game.play_date || 'æœªè®°å½•'}</span>
                        <span class='text-xs'>{game.rating}</span>
                      </div>
                      <p class='mt-3 text-sm text-muted-foreground'>{game.description}</p>
                    </div>
                  </div>
                ))
              }
            </div>
          </>
        )}
      </article>
    </div>
  </div>

  <BackToTop header='content-header' content='content'>
    <button
      slot='other-icons'
      aria-label='Toggle sidebar'
      class='size-10 flex items-center justify-center rounded-full border-2 border-transparent bg-muted text-muted-foreground duration-300 hover:border-border/75 lg:hidden sm:size-12'
      id='sidebar-btn'
    >
      <Icon name='list' />
    </button>
  </BackToTop>
</BaseLayout>

<script>
  const sidebarButton = document.getElementById('sidebar-btn')
  const sidebar = document.getElementById('sidebar-mobile')
  const sidebarShade = document.getElementById('sidebar-shade') as HTMLElement

  if (sidebarShade) {
    sidebarShade.addEventListener('click', () => {
      toggleSidebar()
    })
  }

  function toggleSidebar() {
    if (sidebar && sidebar.style.display !== 'none') {
      sidebar.style.display = 'none'
      sidebarShade.style.display = 'none'
    } else if (sidebar) {
      sidebar.style.display = 'block'
      sidebarShade.style.display = 'block'
    }
  }

  sidebarButton?.addEventListener('click', () => {
    toggleSidebar()
  })
</script>
