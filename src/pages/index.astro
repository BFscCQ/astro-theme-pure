---
import { Image } from 'astro:assets'
import booksData from 'public/books.json'
import gamesData from 'public/games.json'
import moviesData from 'public/movies.json'

import { Quote } from 'astro-pure/advanced'
import { PostPreview } from 'astro-pure/components/pages'
import { getBlogCollection, sortMDByDate } from 'astro-pure/server'
import { Button, Card, Icon, Label } from 'astro-pure/user'
import PageLayout from '@/layouts/BaseLayout.astro'
import ProjectCard from '@/components/home/ProjectCard.astro'
import Section from '@/components/home/Section.astro'
import SkillLayout from '@/components/home/SkillLayout.astro'
import config from '@/site-config'

const languages = ['Html', 'JavaScript', 'CSS', 'Shell']
const frontend = ['TypeScript', 'Vite', 'Webpack', 'Astro']
const backend = ['Vercel', 'Waline']

const MAX_POSTS = 10
const allPosts = await getBlogCollection()
const allPostsByDate = sortMDByDate(allPosts).slice(0, MAX_POSTS)

// 获取最近7天内的活动
interface Activity {
  type: 'movie' | 'series' | 'anime' | 'book' | 'game'
  title: string
  date: string
  cover?: string
  rating?: string
  comment?: string
  link?: string
}

function parseDate(dateStr: string): Date | null {
  if (!dateStr) return null
  // 支持 2025/09/18 或 2025.08.26 格式
  const normalized = dateStr.replace(/\./g, '/')
  const date = new Date(normalized)
  return isNaN(date.getTime()) ? null : date
}

function isWithinDays(dateStr: string, days: number): boolean {
  const date = parseDate(dateStr)
  if (!date) return false
  const now = new Date()
  const diffTime = now.getTime() - date.getTime()
  const diffDays = diffTime / (1000 * 60 * 60 * 24)
  return diffDays >= 0 && diffDays <= days
}

const recentActivities: Activity[] = []

// 从电影数据获取活动
const movieCategories = [
  { key: 'movies', type: 'movie' as const },
  { key: 'series', type: 'series' as const },
  { key: 'anime', type: 'anime' as const }
]

for (const { key, type } of movieCategories) {
  const items = (moviesData as Record<string, any[]>)[key] || []
  for (const item of items) {
    if (item.watchDate && isWithinDays(item.watchDate, 7)) {
      recentActivities.push({
        type,
        title: item.title,
        date: item.watchDate,
        cover: item.cover,
        rating: item.rating,
        comment: item.comment,
        link: '/movies'
      })
    }
  }
}

// 从书籍数据获取活动
const bookCategories = ['reading', 'read']
for (const key of bookCategories) {
  const items = (booksData as Record<string, any[]>)[key] || []
  for (const item of items) {
    if (item.read_date && isWithinDays(item.read_date, 7)) {
      recentActivities.push({
        type: 'book',
        title: item.name,
        date: item.read_date,
        cover: item.image,
        rating: item.rating,
        comment: item.description,
        link: '/books'
      })
    }
  }
}

// 从游戏数据获取活动
const gameCategories = ['playing', 'played']
for (const key of gameCategories) {
  const items = (gamesData as Record<string, any[]>)[key] || []
  for (const item of items) {
    if (item.play_date && isWithinDays(item.play_date, 7)) {
      recentActivities.push({
        type: 'game',
        title: item.name,
        date: item.play_date,
        cover: item.image,
        rating: item.rating,
        comment: item.description,
        link: '/games'
      })
    }
  }
}

// 按日期排序（最新的在前）
recentActivities.sort((a, b) => {
  const dateA = parseDate(a.date)?.getTime() || 0
  const dateB = parseDate(b.date)?.getTime() || 0
  return dateB - dateA
})

// 活动类型映射
const typeLabels: Record<Activity['type'], string> = {
  movie: '看了电影',
  series: '看了剧集',
  anime: '看了动漫',
  book: '读了书籍',
  game: '玩了游戏'
}

const imagePath = config.logo.src
const images = import.meta.glob<{ default: ImageMetadata }>(
  '/src/assets/*.{jpeg,jpg,png,gif,avif,webp}'
)
if (!images[imagePath])
  throw new Error(
    `"${imagePath}" does not exist in glob: "src/assets/*.{jpeg,jpg,png,gif,avif,webp}"`
  )
---

<PageLayout meta={{ title: 'Home' }} highlightColor='#659EB9'>
  <main class='flex w-full flex-col items-center'>
    <section class='animate mb-10 flex flex-col items-center gap-y-7' id='content-header'>
      <Image
        src={images[imagePath]()}
        alt={config.logo.alt || 'Logo'}
        class='h-28 w-auto rounded-full border p-1'
        loading='eager'
        fetchpriority='high'
      />

      <div class='flex flex-col items-center gap-y-4'>
        <h1 class='text-3xl font-bold'>{config.author}</h1>
        <div class='flex flex-wrap justify-center gap-x-7 gap-y-3'>
          <Label title='苏州'>
            <Icon name='location' class='size-5' slot='icon' />
          </Label>
          <Label
            title='源码'
            as='a'
            href='https://github.com/BFscCQ/astro-theme-pure'
            target='_blank'
          >
            <Icon name='github' class='size-5' slot='icon' />
          </Label>
        </div>
      </div>

      {/* Get template */}
      <!-- <a
        href='https://github.com/BFscCQ/astro-theme-pure'
        target='_blank'
        class='flex flex-row items-center gap-x-3 rounded-full border bg-background px-4 py-2 text-sm shadow-sm transition-shadow hover:shadow-md'
      >
        <span class='relative flex items-center justify-center'>
          <span
            class='absolute size-2 animate-ping rounded-full border border-green-400 bg-green-400 opacity-75'
          ></span>
          <span class='size-2 rounded-full bg-green-400'></span>
        </span>
        <p class='font-medium text-muted-foreground'>Get Template</p>
      </a> -->
    </section>

    <div id='content' class='animate flex flex-col gap-y-10 md:w-4/5 lg:w-5/6'>
      <Section title='关于'>
        <p class='text-muted-foreground'>移动安全开发工程师</p>
        <p class='text-muted-foreground'>
          一名移动安全开发工程师，主要负责移动应用加固产品的研发和维护。
          具备多年移动端攻防技术经验，能够为产品提供风险评估、漏洞修复方案以及安全加固支持。
          多年以来一直参与 CAPPVD 与 CNNVD
          的漏洞上报、复现与验证流程，为国内诸多APP项目提供安全加固与合规支持。
        </p>
        <Button title='更多' class='w-fit self-end' href='/about' variant='ahead' />
      </Section>
      <Section title='活动'>
        {
          recentActivities.length > 0 ? (
            <ul class='flex flex-col gap-y-3'>
              {recentActivities.map((activity) => (
                <li>
                  <a
                    href={activity.link}
                    class='flex items-center gap-4 rounded-xl border bg-muted px-4 py-3 transition-all hover:border-foreground/25 hover:shadow-sm'
                  >
                    {activity.cover && (
                      <img
                        src={activity.cover}
                        alt={activity.title}
                        class='h-16 w-12 rounded object-cover'
                        loading='lazy'
                      />
                    )}
                    <div class='flex-1 min-w-0'>
                      <div class='flex items-center gap-2'>
                        <span class='text-xs text-primary bg-primary/10 px-2 py-0.5 rounded'>
                          {typeLabels[activity.type]}
                        </span>
                        <span class='text-xs text-muted-foreground'>{activity.date}</span>
                        {activity.rating && <span class='text-xs'>{activity.rating}</span>}
                      </div>
                      <h3 class='font-medium mt-1 truncate'>{activity.title}</h3>
                      {activity.comment && (
                        <p class='text-sm text-muted-foreground line-clamp-1 mt-0.5'>
                          {activity.comment}
                        </p>
                      )}
                    </div>
                  </a>
                </li>
              ))}
            </ul>
          ) : (
            <p class='text-muted-foreground'>最近7天没有活动记录</p>
          )
        }
      </Section>

      {
        /* <Section title='Experience'>
      <Card
        heading='Lorem Ipsum'
        subheading='Sit amet consectetur'
        date='Dec 2022 - Nov 2023'
        imagePath='/src/assets/about-astro.png'
        altText='Lorem, ipsum dolor sit'
        imageClass='h-12 w-auto md:-start-16'
      >
        <ul class='ms-4 list-disc text-muted-foreground'>
          <li>
            Lorem, ipsum dolor sit amet consectetur adipisicing elit. Dolore debitis recusandae, ut
            molestiae laboriosam pariatur!

            <li>Lorem ipsum dolor sit amet consectetur adipisicing elit. Molestiae, pariatur!</li>
          </li>
        </ul>
      </Card>
      <Card
        heading='Lorem Ipsum'
        subheading='Sit amet consectetur'
        date='Dec 2022 - Nov 2023'
        imagePath='/src/assets/about-astro.png'
        altText='Lorem, ipsum dolor sit'
        imageClass='h-12 w-auto md:-start-16'
      />
    </Section> */
      }

      {
        allPostsByDate.length > 0 && (
          <Section title='文章'>
            <ul class='flex flex-col gap-y-1.5 sm:gap-y-2'>
              {allPostsByDate.map((p) => (
                <li class='flex flex-col gap-x-2 sm:flex-row'>
                  <PostPreview post={p} />
                </li>
              ))}
            </ul>
            <Button title='更多' class='w-fit self-end' href='/blog' variant='ahead' />
          </Section>
        )
      }

      <!-- <Section title='Website List'>
        <div class='grid grid-cols-1 gap-3 sm:grid-cols-2'>
          <ProjectCard
            href='https://www.youtube.com/watch?v=dQw4w9WgXcQ'
            heading='Lorem ipsum'
            subheading='Do not go gentle into that good night'
            imagePath='/src/assets/projects/1.jpg'
          />
          <ProjectCard
            href='https://www.youtube.com/watch?v=dQw4w9WgXcQ'
            heading='Lorem ipsum'
            subheading='Old age burn and rave at close of day'
            imagePath='/src/assets/projects/2.jpg'
          />
          <ProjectCard
            href='https://www.youtube.com/watch?v=dQw4w9WgXcQ'
            heading='Lorem ipsum'
            subheading='Rage, rage against the dying of the light'
            imagePath='/src/assets/projects/3.jpg'
          />
          <ProjectCard
            href='/projects'
            heading='More projects'
            subheading='Check out more projects'
            imagePath='/src/assets/projects/4.jpg'
          />
        </div>
      </Section> -->

      <!-- <Section title='Certifications'>
        <Card
          as='a'
          heading='Lorem ipsum'
          subheading='Lorem ipsum dolor sit amet, vidit suscipit at mei. Quem denique mea id. Usu ei regione indoctum dissentiunt, cu meliore fuisset mei, vel quod voluptua ne. Ex dicat impedit mel, at eum oratio possit voluptatum. Dicat ceteros cu vim. Impetus fuisset ullamcorper pri cu, his posse iisque ad, aliquam honestatis usu id.'
          date='July 2024'
          href='https://www.youtube.com/watch?v=dQw4w9WgXcQ'
        />
      </Section> -->

      <!-- <Section title='技能'>
        <SkillLayout title='编程' skills={languages} />
        <SkillLayout title='生活' skills={frontend} />
        <SkillLayout title='Backend' skills={backend} />
      </Section> -->
    </div>
    <Quote class='mt-12' />
  </main>
</PageLayout>
