---
import data from 'public/books.json'
import { TOC, BackToTop } from 'astro-pure/components/pages'
import { Icon } from 'astro-pure/user'
import BaseLayout from '@/layouts/BaseLayout.astro'
import BookStats from '@/components/books/BookStats.astro'
import config from '@/site-config'

// 类型定义
interface BookItem {
  name: string
  rating?: string
  read_date?: string
  description?: string
  image?: string
  link?: string
}

// 获取所有分类的数据
const reading = data.reading as BookItem[]
const read = data.read as BookItem[]
const waiting = data.waiting as BookItem[]
const notRecommended = data.notRecommended as BookItem[]

// 动态生成 headings，只包含有内容的分类
const headings = [
  ...(reading.length > 0 ? [{ depth: 2, slug: 'reading', text: '正在阅读' }] : []),
  ...(read.length > 0 ? [{ depth: 2, slug: 'read', text: '已读完' }] : []),
  ...(waiting.length > 0 ? [{ depth: 2, slug: 'waiting', text: '暂停阅读' }] : []),
  ...(notRecommended.length > 0 ? [{ depth: 2, slug: 'not-recommended', text: '不推荐' }] : [])
]
---

<BaseLayout
  meta={{ title: '阅读', description: config.description }}
  wide={true}
>
  <div class='grid grid-cols-1 lg:grid-cols-[240px_1fr] gap-10'>
    {/* Sidebar */}
    <aside class='lg:block'>
      <div class='sticky top-24 space-y-8'>
        <TOC headings={headings} />
        <BookStats {reading} {read} {waiting} {notRecommended} />
      </div>
    </aside>

    {/* Mobile sidebar */}
    <aside
      class='lg:hidden fixed top-20 start-4 z-40 w-48 bg-muted border rounded-xl px-4 py-3 overflow-y-auto'
      style='max-height: calc(100vh - 7rem); display: none;'
      id='sidebar-mobile'
    >
      <TOC headings={headings} />
      <BookStats {reading} {read} {waiting} {notRecommended} />
    </aside>
    <div
      id='sidebar-shade'
      class='fixed top-0 start-0 w-full h-full lg:hidden'
      style='display:none;background-color:#00000091;z-index:31'
    >
    </div>

    {/* Main Content */}
    <div class='min-w-0'>
      <div id='content-header' class='animate mb-8'>
        <h1 class='text-3xl font-bold sm:text-4xl'>阅读</h1>
        <p class='mt-2 text-muted-foreground'>这里记录我的阅读历程，包括小说、书籍等。</p>
      </div>

      <article id='content'>
        {/* 正在阅读 */}
        {reading.length > 0 && (
          <>
            <h2 id='reading' class='text-2xl font-semibold mb-6'>正在阅读</h2>
            <div class='grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 mb-12'>
              {
                reading.map((book, index) => (
                  <a href={book.link} target='_blank' rel='noopener noreferrer' class='group overflow-hidden rounded-xl border bg-card shadow-sm transition-all hover:shadow-md'>
                    <div class='overflow-hidden' style='aspect-ratio: 3 / 4;'>
                      <img
                        src={book.image}
                        alt={book.name}
                        class='h-full w-full object-cover transition-transform duration-300 group-hover:scale-105'
                        loading={index < 5 ? 'eager' : 'lazy'}
                        fetchpriority={index < 3 ? 'high' : 'auto'}
                      />
                    </div>
                    <div class='p-3'>
                      <h3 class='text-base font-bold leading-tight'>{book.name}</h3>
                      <div class='mt-1 flex items-center justify-between'>
                        <span class='text-xs text-muted-foreground'>{book.read_date || '未记录'}</span>
                        <span class='text-xs'>{book.rating}</span>
                      </div>
                      <p class='mt-3 text-sm text-muted-foreground'>{book.description}</p>
                    </div>
                  </a>
                ))
              }
            </div>
          </>
        )}

        {/* 已读完 */}
        {read.length > 0 && (
          <>
            <h2 id='read' class='text-2xl font-semibold mb-6'>已读完</h2>
            <div class='grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 mb-12'>
              {
                read.map((book, index) => (
                  <a href={book.link} target='_blank' rel='noopener noreferrer' class='group overflow-hidden rounded-xl border bg-card shadow-sm transition-all hover:shadow-md'>
                    <div class='overflow-hidden' style='aspect-ratio: 3 / 4;'>
                      <img
                        src={book.image}
                        alt={book.name}
                        class='h-full w-full object-cover transition-transform duration-300 group-hover:scale-105'
                        loading={index < 10 ? 'eager' : 'lazy'}
                        fetchpriority={index < 5 ? 'high' : 'auto'}
                      />
                    </div>
                    <div class='p-3'>
                      <h3 class='text-base font-bold leading-tight'>{book.name}</h3>
                      <div class='mt-1 flex items-center justify-between'>
                        <span class='text-xs text-muted-foreground'>{book.read_date || '未记录'}</span>
                        <span class='text-xs'>{book.rating}</span>
                      </div>
                      <p class='mt-3 text-sm text-muted-foreground'>{book.description}</p>
                    </div>
                  </a>
                ))
              }
            </div>
          </>
        )}
        {/* 暂停阅读 */}
        {waiting.length > 0 && (
          <>
            <h2 id='waiting' class='text-2xl font-semibold mb-6'>暂停阅读</h2>
            <div class='grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 mb-12'>
              {
                waiting.map((book) => (
                  <a href={book.link} target='_blank' rel='noopener noreferrer' class='group overflow-hidden rounded-xl border bg-card shadow-sm transition-all hover:shadow-md'>
                    <div class='overflow-hidden' style='aspect-ratio: 3 / 4;'>
                      <img
                        src={book.image}
                        alt={book.name}
                        class='h-full w-full object-cover transition-transform duration-300 group-hover:scale-105'
                        loading='lazy'
                      />
                    </div>
                    <div class='p-3'>
                      <h3 class='text-base font-bold leading-tight'>{book.name}</h3>
                      <div class='mt-1 flex items-center justify-between'>
                        <span class='text-xs text-muted-foreground'>{book.read_date || '未记录'}</span>
                        <span class='text-xs'>{book.rating}</span>
                      </div>
                      <p class='mt-3 text-sm text-muted-foreground'>{book.description}</p>
                    </div>
                  </a>
                ))
              }
            </div>
          </>
        )}

        {/* 不推荐 */}
        {notRecommended.length > 0 && (
          <>
            <h2 id='not-recommended' class='text-2xl font-semibold mb-6'>不推荐</h2>
            <div class='grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5'>
              {
                notRecommended.map((book) => (
                  <a href={book.link} target='_blank' rel='noopener noreferrer' class='group overflow-hidden rounded-xl border bg-card shadow-sm transition-all hover:shadow-md'>
                    <div class='overflow-hidden' style='aspect-ratio: 3 / 4;'>
                      <img
                        src={book.image}
                        alt={book.name}
                        class='h-full w-full object-cover transition-transform duration-300 group-hover:scale-105'
                        loading='lazy'
                      />
                    </div>
                    <div class='p-3'>
                      <h3 class='text-base font-bold leading-tight'>{book.name}</h3>
                      <div class='mt-1 flex items-center justify-between'>
                        <span class='text-xs text-muted-foreground'>{book.read_date || '未记录'}</span>
                        <span class='text-xs'>{book.rating}</span>
                      </div>
                      <p class='mt-3 text-sm text-muted-foreground'>{book.description}</p>
                    </div>
                  </a>
                ))
              }
            </div>
          </>
        )}
      </article>
    </div>
  </div>

  <BackToTop header='content-header' content='content'>
    <button
      slot='other-icons'
      aria-label='Toggle sidebar'
      class='size-10 flex items-center justify-center rounded-full border-2 border-transparent bg-muted text-muted-foreground duration-300 hover:border-border/75 lg:hidden sm:size-12'
      id='sidebar-btn'
    >
      <Icon name='list' />
    </button>
  </BackToTop>
</BaseLayout>

<script>
  const sidebarButton = document.getElementById('sidebar-btn')
  const sidebar = document.getElementById('sidebar-mobile')
  const sidebarShade = document.getElementById('sidebar-shade') as HTMLElement

  if (sidebarShade) {
    sidebarShade.addEventListener('click', () => {
      toggleSidebar()
    })
  }

  function toggleSidebar() {
    if (sidebar && sidebar.style.display !== 'none') {
      sidebar.style.display = 'none'
      sidebarShade.style.display = 'none'
    } else if (sidebar) {
      sidebar.style.display = 'block'
      sidebarShade.style.display = 'block'
    }
  }

  sidebarButton?.addEventListener('click', () => {
    toggleSidebar()
  })
</script>
