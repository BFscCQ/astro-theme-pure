---
import data from 'public/movies.json'
import { TOC, BackToTop } from 'astro-pure/components/pages'
import { Icon } from 'astro-pure/user'
import BaseLayout from '@/layouts/BaseLayout.astro'
import config from '@/site-config'

import '@/assets/styles/global.css'
import '@/assets/styles/app.css'

// 类型定义
interface WatchedItem {
  title: string
  watchDate?: string
  cover?: string
  rating?: string
  comment?: string
}

interface WantToWatchItem {
  title: string
  cover?: string
  reason?: string
}

const TMDB_API_KEY = import.meta.env.TMDB_API_KEY

// 简单的内存缓存
const coverCache = new Map<string, string>()

// 延迟函数
const delay = (ms: number) => new Promise((resolve) => setTimeout(resolve, ms))

// 通过 TMDB API 获取封面（带缓存和重试）
async function fetchCover(title: string, retries = 2): Promise<string | null> {
  if (!TMDB_API_KEY) return null

  // 检查缓存
  if (coverCache.has(title)) {
    return coverCache.get(title) || null
  }

  for (let i = 0; i < retries; i++) {
    try {
      const res = await fetch(
        `https://api.themoviedb.org/3/search/multi?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(title)}&language=zh-CN`,
        { signal: AbortSignal.timeout(5000) } // 5秒超时
      )
      const data = await res.json()
      if (data.results?.[0]?.poster_path) {
        const cover = `https://www.themoviedb.org/t/p/w600_and_h900_face${data.results[0].poster_path}`
        coverCache.set(title, cover)
        return cover
      }
      return null
    } catch (e) {
      if (i < retries - 1) {
        await delay(500 * (i + 1))
        continue
      }
      console.error(`Failed to fetch cover for ${title}`)
    }
  }
  return null
}

// 批量处理，只为缺少 cover 的项目获取封面
async function enrichWithCovers<T extends { title: string; cover?: string }>(items: T[]): Promise<T[]> {
  // 筛选出需要获取封面的项目
  const needsFetch = items.filter((item) => !item.cover && TMDB_API_KEY)

  // 如果没有需要获取的，直接返回
  if (needsFetch.length === 0) {
    return items
  }

  // 并发获取缺失的封面（限制并发数为 3）
  const concurrency = 3
  for (let i = 0; i < needsFetch.length; i += concurrency) {
    const batch = needsFetch.slice(i, i + concurrency)
    await Promise.all(batch.map((item) => fetchCover(item.title)))
    if (i + concurrency < needsFetch.length) await delay(200)
  }

  // 返回带有封面的数据
  return items.map((item) => ({
    ...item,
    cover: item.cover || coverCache.get(item.title) || ''
  }))
}

// 获取所有分类的数据并填充封面
const wantToWatch = await enrichWithCovers(data.wantToWatch as WantToWatchItem[])
const movies = await enrichWithCovers(data.movies as WatchedItem[])
const tvShows = await enrichWithCovers(data.tvShows as WatchedItem[])
const anime = await enrichWithCovers(data.anime as WatchedItem[])

// 动态生成 headings，只包含有内容的分类
const headings = [
  ...(wantToWatch.length > 0 ? [{ depth: 2, slug: 'want-to-watch', text: '想看' }] : []),
  ...(movies.length > 0 ? [{ depth: 2, slug: 'movies', text: '电影' }] : []),
  ...(tvShows.length > 0 ? [{ depth: 2, slug: 'tv-shows', text: '剧集' }] : []),
  ...(anime.length > 0 ? [{ depth: 2, slug: 'anime', text: '动漫' }] : [])
]
---

<BaseLayout meta={{ title: 'Movies', description: config.description }} wide={true}>
  <main class='flex-1 w-full py-8'>
    <div class='flex gap-8 mx-auto'>
      {/* Sidebar - 左侧 */}
      <aside
        class='hidden lg:block w-48 shrink-0 sticky top-20 self-start'
        style='max-height: calc(100vh - 7rem);'
        id='sidebar'
      >
        <TOC headings={headings} />
      </aside>

      {/* Mobile sidebar */}
      <aside
        class='lg:hidden fixed top-20 start-4 z-40 w-48 bg-muted border rounded-xl px-4 py-3 overflow-y-auto'
        style='max-height: calc(100vh - 7rem); display: none;'
        id='sidebar-mobile'
      >
        <TOC headings={headings} />
      </aside>
      <div
        id='sidebar-shade'
        class='fixed top-0 start-0 w-full h-full lg:hidden'
        style='display:none;background-color:#00000091;z-index:31'
      >
      </div>

      {/* Main content */}
      <div class='flex-1 min-w-0'>
        {/* Page header */}
        <div id='content-header' class='animate mb-8'>
          <h1 class='text-3xl font-bold sm:text-4xl'>影视</h1>
          <p class='mt-2 text-muted-foreground'>这里记录我的观影历程，包括电影、剧集和动漫。</p>
        </div>

        <article id='content'>
          {/* Want to watch */}
          {wantToWatch.length > 0 && (
            <>
              <h2 id='want-to-watch' class='text-2xl font-semibold mb-6'>想看</h2>
              <div class='grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 mb-12'>
                {
                  wantToWatch.map((item) => (
                    <div class='group overflow-hidden rounded-xl border bg-card shadow-sm transition-all hover:shadow-md'>
                      <div class='overflow-hidden' style='aspect-ratio: 486 / 730;'>
                        <img
                          src={item.cover}
                          alt={item.title}
                          class='h-full w-full object-cover transition-transform duration-300 group-hover:scale-105'
                        />
                      </div>
                      <div class='p-3'>
                        <h3 class='text-base font-bold leading-tight'>{item.title}</h3>
                        <p class='mt-2 text-xs text-muted-foreground'>{item.reason}</p>
                      </div>
                    </div>
                  ))
                }
              </div>
            </>
          )}

          {/* Movies */}
          <h2 id='movies' class='text-2xl font-semibold mb-6'>电影</h2>
          <div class='grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 mb-12'>
            {
              movies.map((movie, index) => (
                <div class='group overflow-hidden rounded-xl border bg-card shadow-sm transition-all hover:shadow-md'>
                  <div class='overflow-hidden' style='aspect-ratio: 486 / 730;'>
                    <img
                      src={movie.cover}
                      alt={movie.title}
                      class='h-full w-full object-cover transition-transform duration-300 group-hover:scale-105'
                      loading={index < 10 ? 'eager' : 'lazy'}
                      fetchpriority={index < 5 ? 'high' : 'auto'}
                    />
                  </div>
                  <div class='p-3'>
                    <h3 class='text-base font-bold leading-tight'>{movie.title}</h3>
                    <div class='mt-1 flex items-center justify-between'>
                      <span class='text-xs text-muted-foreground'>{movie.watchDate || '未记录'}</span>
                      <span class='text-xs'>{movie.rating}</span>
                    </div>
                    <p class='mt-2 text-xs text-muted-foreground'>{movie.comment}</p>
                  </div>
                </div>
              ))
            }
          </div>

          {/* TV Shows */}
          <h2 id='tv-shows' class='text-2xl font-semibold mb-6'>剧集</h2>
          <div class='grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 mb-12'>
            {
              tvShows.map((show, index) => (
                <div class='group overflow-hidden rounded-xl border bg-card shadow-sm transition-all hover:shadow-md'>
                  <div class='overflow-hidden' style='aspect-ratio: 486 / 730;'>
                    <img
                      src={show.cover}
                      alt={show.title}
                      class='h-full w-full object-cover transition-transform duration-300 group-hover:scale-105'
                      loading={index < 5 ? 'eager' : 'lazy'}
                    />
                  </div>
                  <div class='p-3'>
                    <h3 class='text-base font-bold leading-tight'>{show.title}</h3>
                    <div class='mt-1 flex items-center justify-between'>
                      <span class='text-xs text-muted-foreground'>{show.watchDate || '未记录'}</span>
                      <span class='text-xs'>{show.rating}</span>
                    </div>
                    <p class='mt-2 text-xs text-muted-foreground'>{show.comment}</p>
                  </div>
                </div>
              ))
            }
          </div>

          {/* Anime */}
          <h2 id='anime' class='text-2xl font-semibold mb-6'>动漫</h2>
          <div class='grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5'>
            {
              anime.map((item, index) => (
                <div class='group overflow-hidden rounded-xl border bg-card shadow-sm transition-all hover:shadow-md'>
                  <div class='overflow-hidden' style='aspect-ratio: 486 / 730;'>
                    <img
                      src={item.cover}
                      alt={item.title}
                      class='h-full w-full object-cover transition-transform duration-300 group-hover:scale-105'
                      loading={index < 5 ? 'eager' : 'lazy'}
                      fetchpriority={index === 0 ? 'high' : 'auto'}
                    />
                  </div>
                  <div class='p-3'>
                    <h3 class='text-base font-bold leading-tight'>{item.title}</h3>
                    <div class='mt-1 flex items-center justify-between'>
                      <span class='text-xs text-muted-foreground'>{item.watchDate || '未记录'}</span>
                      <span class='text-xs'>{item.rating}</span>
                    </div>
                    <p class='mt-2 text-xs text-muted-foreground'>{item.comment}</p>
                  </div>
                </div>
              ))
            }
          </div>
        </article>
      </div>
    </div>
  </main>

  <BackToTop header='content-header' content='content'>
    <button
      slot='other-icons'
      aria-label='Toggle sidebar'
      class='size-10 flex items-center justify-center rounded-full border-2 border-transparent bg-muted text-muted-foreground duration-300 hover:border-border/75 lg:hidden sm:size-12'
      id='sidebar-btn'
    >
      <Icon name='list' />
    </button>
  </BackToTop>
</BaseLayout>

<script>
  const sidebarButton = document.getElementById('sidebar-btn')
  const sidebar = document.getElementById('sidebar-mobile')
  const sidebarShade = document.getElementById('sidebar-shade') as HTMLElement

  if (sidebarShade) {
    sidebarShade.addEventListener('click', () => {
      toggleSidebar()
    })
  }

  function toggleSidebar() {
    if (sidebar && sidebar.style.display !== 'none') {
      sidebar.style.display = 'none'
      sidebarShade.style.display = 'none'
    } else if (sidebar) {
      sidebar.style.display = 'block'
      sidebarShade.style.display = 'block'
    }
  }

  sidebarButton?.addEventListener('click', () => {
    toggleSidebar()
  })
</script>

