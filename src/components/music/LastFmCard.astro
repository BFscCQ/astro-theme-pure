---
import { Icon } from 'astro-pure/user'
---

<div
  class='relative overflow-hidden rounded-xl border bg-card p-5 shadow-sm transition-all hover:shadow-md'
  id='lastfm-card'
  style='display: none;'
>
  <!-- Rhythm Background -->
  <div
    id='lastfm-rhythm'
    class='absolute inset-0 z-0 flex items-end justify-center gap-0.5 opacity-[0.15]'
    style='display: none;'
  >
    {
      Array.from({ length: 12 }).map((_, i) => (
        <div
          class='w-full bg-primary/80 rounded-t-sm'
          style={`animation: rhythm 1s ease-in-out infinite; animation-delay: ${Math.random()}s; animation-duration: ${0.8 + Math.random() * 0.5}s`}
        />
      ))
    }
  </div>

  <div class='relative z-10 flex items-center gap-5'>
    <div class='relative shrink-0'>
      <img
        id='lastfm-cover'
        src='/favicon/android-chrome-512x512.png'
        alt='Album Cover'
        class='size-20 rounded-md object-cover shadow-sm'
      />
      <div
        id='lastfm-playing'
        class='absolute -bottom-1 -end-1 flex size-6 items-center justify-center rounded-full bg-primary text-primary-foreground shadow-sm ring-2 ring-card'
        style='display: none;'
      >
        <Icon name='play' class='size-3.5 animate-pulse' />
      </div>
    </div>
    <div class='min-w-0 flex-1'>
      <div class='flex items-center justify-between mb-1'>
        <span class='text-xs font-medium text-muted-foreground'>Last.fm</span>
      </div>
      <a id='lastfm-link' href='#' target='_blank' class='block hover:underline'>
        <h3 id='lastfm-title' class='truncate text-base font-bold leading-tight'></h3>
      </a>
      <p id='lastfm-artist' class='truncate text-sm text-muted-foreground mt-0.5'></p>
    </div>
  </div>
</div>

<style>
  @keyframes rhythm {
    0%,
    100% {
      height: 10%;
    }
    50% {
      height: 70%;
    }
  }
</style>

<script>
  async function fetchLastFm() {
    const card = document.getElementById('lastfm-card')
    const cover = document.getElementById('lastfm-cover') as HTMLImageElement
    const title = document.getElementById('lastfm-title')
    const artist = document.getElementById('lastfm-artist')
    const link = document.getElementById('lastfm-link') as HTMLAnchorElement
    const playing = document.getElementById('lastfm-playing')
    const rhythm = document.getElementById('lastfm-rhythm')

    if (!card || !cover || !title || !artist || !link || !playing || !rhythm) return

    try {
      const response = await fetch('/api/lastfm')
      if (!response.ok) throw new Error('Network response was not ok')

      const data = await response.json()

      if (data.isPlaying) {
        // Update text content
        title.textContent = data.title
        artist.textContent = data.artist
        link.href = data.url
        playing.style.display = 'flex'
        rhythm.style.display = 'flex'

        // Preload and update image
        if (data.cover) {
          const img = new Image()
          img.src = data.cover
          img.onload = () => {
            cover.src = data.cover
          }
        }
      } else {
        title.textContent = '当前未在听歌'
        artist.textContent = ''
        link.href = 'https://last.fm'
        playing.style.display = 'none'
        rhythm.style.display = 'none'
        cover.src = '/favicon/android-chrome-512x512.png'
      }

      // Show card with default image first
      card.style.display = 'block'
    } catch (e) {
      // Fallback display
      console.error('Failed to fetch Last.fm data', e)
      cover.src = '/favicon/android-chrome-512x512.png'
      title.textContent = '暂无播放'
      artist.textContent = ''
      link.href = 'https://last.fm'
      playing.style.display = 'none'
      rhythm.style.display = 'none'
      card.style.display = 'block'
    }
  }

  // Fetch on load
  fetchLastFm()
</script>
