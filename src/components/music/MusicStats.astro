---
interface Props {
  listening: any[]
  listened: any[]
  albums: any[]
}

const { listening, listened, albums } = Astro.props

// Calculate statistics
const totalListening = listening.length
const totalListened = listened.length
const totalAlbums = albums.length
const totalTracks = totalListening + totalListened

// Calculate rating distribution
const allItems = [...listening, ...listened, ...albums]
const ratingCounts = {
  '5星': 0,
  '4星': 0,
  '3星': 0,
  '2星': 0,
  '1星': 0
}

allItems.forEach((item) => {
  if (item.rating) {
    const starCount = (item.rating.match(/⭐/g) || []).length
    if (starCount >= 1 && starCount <= 5) {
      const key = `${starCount}星` as keyof typeof ratingCounts
      ratingCounts[key]++
    }
  }
})

const maxCount = Math.max(...Object.values(ratingCounts))
---

<div class='mt-8 border-t pt-8'>
  <div class='mb-4 flex items-center justify-between'>
    <h2 class='text-lg font-semibold'>统计</h2>
    <div class='text-xs text-muted-foreground'>
      共收录 <span class='font-medium text-foreground'>{totalTracks + totalAlbums}</span> 项内容
    </div>
  </div>
  
  <div class='space-y-4'>
    {/* Total Counts */}
    <div class='grid grid-cols-3 gap-2 text-center'>
      <div class='rounded-lg bg-muted/50 p-2'>
        <div class='text-2xl font-bold'>{totalListening}</div>
        <div class='text-xs text-muted-foreground'>正在听</div>
      </div>
      <div class='rounded-lg bg-muted/50 p-2'>
        <div class='text-2xl font-bold'>{totalListened}</div>
        <div class='text-xs text-muted-foreground'>听过单曲</div>
      </div>
      <div class='rounded-lg bg-muted/50 p-2'>
        <div class='text-2xl font-bold'>{totalAlbums}</div>
        <div class='text-xs text-muted-foreground'>听过专辑</div>
      </div>
    </div>

    {/* Rating Distribution */}
    <div class='space-y-2'>
      <div class='text-xs font-medium text-muted-foreground'>评分分布</div>
      <div class='space-y-1.5'>
        {Object.entries(ratingCounts).reverse().map(([rating, count]) => (
          <div class='flex items-center gap-2 text-xs'>
            <div class='w-8 shrink-0 text-muted-foreground'>{rating}</div>
            <div class='flex-1 overflow-hidden rounded-full bg-muted/50'>
              <div 
                class='h-1.5 rounded-full bg-primary transition-all duration-500'
                style={`width: ${maxCount > 0 ? (count / maxCount) * 100 : 0}%`}
              ></div>
            </div>
            <div class='w-6 shrink-0 text-right text-muted-foreground'>{count}</div>
          </div>
        ))}
      </div>
    </div>
  </div>
</div>
